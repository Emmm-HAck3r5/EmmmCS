%
% Copyright 2018 EmmmHackers
% 
% 
% Licensed under the Apache License, Version 2.0 (the "License");
% you may not use this file except in compliance with the License.
% You may obtain a copy of the License at
% 
% 
%       http://www.apache.org/licenses/LICENSE-2.0
% 
% 
% Unless required by applicable law or agreed to in writing, software
% distributed under the License is distributed on an "AS IS" BASIS,
% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
% See the License for the specific language governing permissions and
% limitations under the License.
% --------------------------
% File: cpu_modules.tex
% Project: EmmmCS
% File Created: 2018-11-21 16:11:51
% Author: Chen Haodong (easyai@outlook.com)
% --------------------------
% Last Modified: 2018-11-25 11:50:31
% Modified By: Chen Haodong (easyai@outlook.com)
%

\chapter{模块}
各模块位于同名文件内。

% cpu_gregs moudule
\section{cpu\_gregs}
\subsection{基本信息}
模块名：cpu\_gregs
\subsection{接口}
\begin{tabular}{|c|c|c|c|}
    \hline
    类型    &   位宽    &   名称    &   说明\\\hline
    input   &   1   &   clk &   时钟\\\hline
    input   &   1   &   rd\_wen  &   目标寄存器写使能\\\hline
    input   &   CPU\_GREGIDX\_WIDTH &   rs1\_idx    &   rs1下标\\\hline
    input   &   CPU\_GREGIDX\_WIDTH &   rs2\_idx    &   rs2下标\\\hline
    input   &   CPU\_GREGIDX\_WIDTH &   rd\_idx    &   rd下标\\\hline
    output   &   CPU\_XLEN &   rs1\_dat    &   rs1数据\\\hline
    output   &   CPU\_XLEN &   rs2\_dat    &   rs2数据\\\hline
    input   &   CPU\_XLEN &   rd\_dat    &   rd数据\\\hline
\end{tabular}
\subsection{说明}
本模块定义CPU通用寄存器组，在时钟上升沿完成数据写入和读取，遵循先读后写顺序。

% cpu_gregs moudule
\section{cpu\_alu}
\subsection{基本信息}
模块名：cpu\_alu\\
\indent所需时间：(未定)
\subsection{接口}
\begin{tabular}{|c|c|c|c|}
    \hline
    类型       &   位宽    &   名称    &   说明\\\hline
    input      &   32      &   src\_A   &   A 输入端\\\hline
    input      &   32      &   src\_B   &   B 输入端\\\hline
    input      &   4       &    select  &   功能控制端\\\hline
    output reg &   64      &    dest    &   输出端\\\hline
    output reg &   4       &    flags   &   \{CF, OF, ZF, SF\}\\\hline
    output reg &   1       &    READY   &   双向控制信号\\\hline
\end{tabular}
\subsection{select控制端真值表}
\begin{tabular}{|c|c|c|c|}
    \hline
    select      &   指令   &      操作\\\hline
    0000        &   ADD     &    ${dest := src\_A + src\_B}$\\\hline
    0001        &   SUB     &    ${dest := src\_A - src\_B}$\\\hline
    0010        &   AND     &    ${dest := src\_A\ \&\ src\_B}$\\\hline
    0011        &   OR     &     ${dest := src\_A\ |\ src\_B}$\\\hline
    0100        &   XOR     &    ${dest := src\_A \oplus src\_B}$\\\hline
    0101        &   SLL     &    ${dest := src\_A \ll src\_B}$\\\hline
    0110        &   SRL     &    ${dest := src\_A \gg src\_B}$\\\hline
    0111        &   SRA     &    ${dest := src\_A \gg src\_B}$\\\hline
    1000        &   MUL     &    ${dest := src\_A\ *\ src\_B}$\\\hline
    1001        &   MULU    &    ${dest := src\_A\ *\ src\_B}$\\\hline
    1010        &   MULSU   &    ${dest := src\_A\ *\ src\_B}$\\\hline
    1011        &   DIV     &    ${dest := src\_A\ /\ src\_B}$\\\hline
    1100        &   DIVU     &   ${dest := src\_A\ /\ src\_B}$\\\hline
    1101        &   REM     &    ${dest := src\_A\ \%\ src\_B}$\\\hline
    1110        &   REMU     &   ${dest := src\_A\ \%\ src\_B}$\\\hline
    1111        &   NOP     &    ${dest := 0}$\\\hline
\end{tabular}
\subsection{说明}
将双端口READY置零后，ALU开始进行运算。当READY恢复高电平时，表示运算已完成。\\
\indent指令带\ U\ 后缀表示操作为无符号整形操作。若无后缀，默认为有符号整形操作。注意，指令\ MULSU\ 为 ${sign * unsigned}$ 操作。dest 高32位仅在乘法操作(MUL, MULU, MULSU)时有效，其他操作结果都放在低32位，高32位置零。指令标志位按 i386 手册上定义设置。

% cpu_bus_ctrl moudule
\section{cpu\_bus\_ctrl}
\subsection{基本信息}
模块名：cpu\_bus\_ctrl\\
\indent所需周期：1 到 5 个周期
\subsection{内部接口}
\begin{tabular}{|c|c|c|c|}
    \hline
    类型        &   位宽    &   名称    &   说明\\\hline
    input       &   1      &    clk     &   时钟信号\\\hline
    input       &   26     &    address &   地址端\\\hline
    input       &   32      &   wdata   &   写入数据\\\hline
    input       &   2       &   WLEN    &   SDRAM读写控制\\\hline
    inout       &   1       &   READY   &   双向控制信号\\\hline
    output reg  &   32      &   rdata   &   读取数据\\\hline
\end{tabular}
\subsection{SDRAM接口}
\begin{tabular}{|c|c|c|c|}
    \hline
    类型        &   位宽    &   名称    &   说明\\\hline
    output reg  &   13     &    ADDR   &    DRAM\_ADDR[12..0]\\\hline
    output reg  &   2       &   BA      &   DRAM\_BA[1..0]\\\hline
    output reg  &   16      &   DQ      &   DRAM\_DQ[15..0]\\\hline
    output reg  &   1       &   CKE     &   DRAM\_CKE\\\hline 
    output reg  &   1       &   CS\_N     &   DRAM\_CS\_N\\\hline 
    output reg  &   1       &   RAS\_N     &   DRAM\_RAS\_N\\\hline 
    output reg  &   1       &   CAS\_N     &   DRAM\_CAS\_N\\\hline 
    output reg  &   2       &   DMASK     &  \{DRAM\_UDQM, DRAM\_LDQM\}\\\hline 
\end{tabular}
\subsection{WLEN控制信号真值表}
\begin{tabular}{|c|c|c|}
    \hline
    WLEN[1]  &  WLEN[0] &       功能\\\hline
    0       &   0       &       32位读取操作\\\hline
    0       &   1       &       8位写入操作\\\hline
    1       &   0       &       16位写入操作\\\hline
    1       &   1       &       32位写入操作\\\hline
\end{tabular}
\subsection{说明}
SDRAM接口部份，请参考DE10-Standard User Manual 第39页 Table3-23。\\
\indent将双端口READY置零后，总线开始进行读写操作。当READY恢复高电平时，表示读写操作已完成。因为没有输入数据缓存，操作完成之前更改输入可能发生无法预料的结果。\\
\indent读取操作固定返回输入地址后4个字节长的数据。执行写入操作时，超出写入长度的数据将被忽略。当地址输入端address最高位为高电位时，表示对片内寄存器进行读写操作，而非SDRAM，所需时间皆为 1 个时钟周期。

\section{cpu\_instr\_decoder}
\subsection{基本信息}
模块名：cpu\_instr\_decoder
\subsection{接口}
\begin{tabular}{|c|c|c|c|}
    \hline
    类型    &   位宽    &   名称    &   说明\\\hline
    input   &   CPU\_INSTR\_LENGTH   &   instr &   输入指令\\\hline
    output   &   CPU\_GREGIDX\_WIDTH &   rs1\_idx    &   rs1下标\\\hline
    output   &   CPU\_GREGIDX\_WIDTH &   rs2\_idx    &   rs2下标\\\hline
    output   &   CPU\_GREGIDX\_WIDTH &   rs3\_idx    &   rs3下标\\\hline
    output   &   CPU\_GREGIDX\_WIDTH &   rd\_idx    &   rd下标\\\hline
    output   &   CPU\_XLEN &   imm    &   立即数\\\hline
    output   &   FUNCT\_WIDTH &   funct    &   funct\\\hline
    output   &   OPCODE\_WIDTH &   opcode    &   opcode\\\hline
    output   &   CPU\_INSTR\_DECODE\_INFO\_WIDTH &   dec\_instr\_info    &   指令解码信息\\\hline
    output   &   1 &   instr\_valid    &   指令是否有效\\\hline
    output   &   1 &   fp\_rm    &   浮点数rm\\\hline
    output   &   1 &   fp\_width    &   浮点数width\\\hline
    output   &   1 &   fp\_fmt    &   浮点数fmt\\\hline
\end{tabular}
\subsection{常量}
\begin{tabular}{|c|p{3cm}|p{6cm}|}
    \hline
    名称    &   值  &   说明\\\hline
    FUNCT\_WIDTH & 10 & funct位宽\\\hline
    OPCODE\_WIDTH & 7 & opcode位宽\\\hline
\end{tabular}
\subsection{说明}
本模块定义CPU指令解码器，对输入指令给出相应解码内容。应注意指令解码信息(dec\_instr\_info)中，低CPU\_INSTR\_OPR\_INFO\_WIDTH位为操作数信息，高CPU\_INSTR\_INFO\_WIDTH位为指令组信息。具体信息编码见1.2节。